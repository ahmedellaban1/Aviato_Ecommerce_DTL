{% extends 'base.html' %}
{% load static %}

{% block container %}
    {% if messages %}
        <div class="alert-wrapper">
            <div id="messageAlert" class="container ">
                <div class="alertPart mt-50">
                    {% for message in messages %}
                        {% if 'success' in message.tags %}
                            <div class="alert alert-success alert-common alert-dismissible " role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <i class="tf-ion-thumbsup"></i><span>Success! </span>{{message}}
                            </div>
                        {% elif 'error' in message.tags %}
                            <div class="alert alert-danger alert-common alert-dismissible " role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <i class="tf-ion-thumbsup"></i><span>Warning! </span>{{message}}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
    <section class="single-product">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <ol class="breadcrumb">
                        <li><a href="{% url 'products-main-url:home-page-url' %}">Home</a></li>
                        <li><a href="{% url 'products-main-url:shop-products-url' %}">Shop</a></li>
                        <li class="active">Single Product</li>
                    </ol>
                </div>
                <div class="col-md-6">
                    <ol class="product-pagination text-right">
                        {% if next_product %}
                            <li><a href="{% url 'products-main-url:product-details-url' pk=next_product.id %}"><i class="tf-ion-ios-arrow-left"></i> Next </a></li>
                        {% else %}
                            <li><a href="#" aria-disabled="true"><i class="tf-ion-ios-arrow-left"></i> No Next </a></li>
                        {% endif %}
                        {% if previous_product %}
                            <li><a href="{% url 'products-main-url:product-details-url' pk=previous_product.id %}">Previous <i class="tf-ion-ios-arrow-right"></i></a></li>
                        {% else %}
                            <li><a href="#">No Previous <i class="tf-ion-ios-arrow-right"></i></a></li>
                        {% endif %}

                    </ol>
                </div>
            </div>
            <div class="row mt-20">
                <div class="col-md-5">
                    <div class="single-product-slider">
                        <div id='carousel-custom' class='carousel slide' data-ride='carousel'>
                            <div class='carousel-outer'>
                                <!-- me art lab slider -->
                                <div class='carousel-inner '>
                                    {% for image in images %}
                                        <div class='item {% if forloop.first %}active{% endif %}'>
                                            <img src="{{ image.file_url.url}}"
                                                 alt='{{ image.alt_text }}'
                                                 data-zoom-image="{{ image.file_url.url}}"
                                            />
                                        </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- sag sol -->
                                <a class='left carousel-control' href='#carousel-custom' data-slide='prev'>
                                    <i class="tf-ion-ios-arrow-left"></i>
                                </a>
                                <a class='right carousel-control' href='#carousel-custom' data-slide='next'>
                                    <i class="tf-ion-ios-arrow-right"></i>
                                </a>
                            </div>
                            
                            <!-- thumb -->
                            <ol class='carousel-indicators mCustomScrollbar meartlab'>
                                {% for image in images %}
                                    <li data-target='#carousel-custom' data-slide-to='0' class='{% if forloop.first %}active{% endif %}'>
                                        <img src='{{ image.file_url.url }}'
                                             alt='{{ image.alt_text }}'
                                             data-zoom-image="{{ forloop.counter0 }}" />
                                    </li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="single-product-details">
                        <h2>{{product.title}}</h2>
                        <p class="product-price">${{product.price}}</p>
                        <p class="product-description mt-20">
                            {{product.description}}
                        </p>
                        <div class="color-swatches">
                            <span>Color:</span>
                            <ul id="color-options">
                                {% for color in product_colors %}
                                    <li 
                                        class="single-product-color" 
                                        style="background-color: {{ color.color_code }};" 
                                        data-color-id="{{ color.id }}"
                                        title="{{ color.name }}">
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>

                        <div class="product-size">
                            <span>Size:</span>
                            <select class="form-control" id="size-select">
                                {% for size in product_sizes %}
                                    <option value="{{ size.id }}">{{ size.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="product-quantity">
                            <span>Quantity:</span>
                            <div class="product-quantity-slider">
                                <input id="product-quantity" type="text" value="1" name="product-quantity">
                            </div>
                        </div>

                        <div class="product-category">
                            <span>Categories:</span>
                            <ul style="display: inline;">
                                {% for category in product_categories %}
                                    <li><a href="{% url 'products-main-url:shop-products-url' %}?category={{category.title}}">{{category.title}}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        <!-- add to cart form -->
                        <form id="add-to-cart-form" action="/orderhub/add_to_cart/" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <!-- Hidden input inside the form to capture selected color -->
                            <input type="hidden" name="color_id" id="form-color-id">
                            <!-- Hidden input inside the form to capture selected size -->
                            <input type="hidden" name="size_id" id="form-size-id">
                            <!-- Hidden quantity field -->
                            <input type="hidden" name="quantity" id="form-quantity" value="">

                            <button class="btn btn-main mt-20" type="submit">Add to Cart</button>
                        </form>
                        <!-- Script -->
                       <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                const form = document.getElementById('add-to-cart-form');
                                const quantityInput = document.getElementById('product-quantity');
                                const hiddenQuantityInput = document.getElementById('form-quantity');
                                const sizeSelect = document.getElementById('size-select');
                                const hiddenSizeInput = document.getElementById('form-size-id');
                                const colorOptions = document.querySelectorAll('.single-product-color');
                                const hiddenColorInput = document.getElementById('form-color-id');

                                let selectedColorId = null;

                                // Color selection logic
                                colorOptions.forEach(function (colorOption) {
                                    colorOption.addEventListener('click', function () {
                                        // Remove "selected" class from all colors
                                        colorOptions.forEach(function (el) {
                                            el.classList.remove('selected');
                                        });

                                        // Add "selected" class to the clicked one
                                        colorOption.classList.add('selected');

                                        // Store the selected color ID
                                        selectedColorId = colorOption.getAttribute('data-color-id');
                                        hiddenColorInput.value = selectedColorId;
                                    });
                                });

                                form.addEventListener('submit', function (event) {
                                    const quantity = quantityInput.value.trim();
                                    const selectedSizeId = sizeSelect.value;

                                    // Validate quantity
                                    if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
                                        event.preventDefault();
                                        alert('Please enter a valid quantity.');
                                        return;
                                    }

                                    // Validate color selection
                                    if (!selectedColorId) {
                                        event.preventDefault();
                                        alert('Please select a color.');
                                        return;
                                    }

                                    // Assign values to hidden inputs
                                    hiddenQuantityInput.value = quantity;
                                    hiddenSizeInput.value = selectedSizeId;
                                    // hiddenColorInput is already updated on click
                                });
                            });
                        </script>


                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="tabCommon mt-20">
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#details" aria-expanded="true">Details</a></li>
                            <li class=""><a data-toggle="tab" href="#reviews" aria-expanded="false">Reviews ({{product_reviews.count}})</a></li>
                        </ul>
                        <div class="tab-content patternbg">
                            <div id="details" class="tab-pane fade active in">
                                <h4>Product Description</h4>
                                <p>{{ product.description }}</p>
                            </div>
                            <div id="reviews" class="tab-pane fade">
                                <div class="post-comments">
                                    <ul class="media-list comments-list m-bot-50 clearlist">
                                        {% for review in product_reviews %}
                                            <!-- Comment Item start-->
                                            <li class="media">
                                                <a class="pull-left" href="#!">
                                                    <img class="media-object comment-avatar" src="{{review.user.profile.image.url}}" alt="" width="50" height="50" />
                                                </a>
                                                <div class="media-body">
                                                    <div class="comment-info">
                                                        <h4 class="comment-author">
                                                            <a href="#!">{{review.user.first_name}} {{review.user.last_name}}</a>
                                                        </h4>
                                                        <time>{{review.created_at}}</time>
                                                        <a class="comment-button" href="#!"><i class="tf-ion-chatbubbles"></i>Reply</a>
                                                    </div>
                                                    <p>
                                                        {{ review.comment }}
                                                    </p>
                                                </div>
                                            </li>
                                            <!-- End Comment Item -->
                                        {% endfor %}
                                </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}
